From 7b4435172e6f8b2d6a59c813fc4c3cc91006a3ba Mon Sep 17 00:00:00 2001
From: Mika Laitio <lamikr@gmail.com>
Date: Sat, 14 Sep 2024 17:30:21 -0700
Subject: [PATCH 1/3] rocm sdk builder fixes

- path fixes
- amql profiler load as a shared library

Signed-off-by: Mika Laitio <lamikr@gmail.com>
---
 CMakeLists.txt                             | 2 +-
 src/core/metrics.h                         | 5 +++--
 src/core/session/att/continuous.cpp        | 2 +-
 src/util/hsa_rsrc_factory.cpp              | 2 ++
 tests-v2/unittests/profiler/CMakeLists.txt | 6 +++---
 5 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 60382f9..6ff0097 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -190,7 +190,7 @@ endif()
 enable_testing()
 
 # Temporarily for CI to work
-set(ROCPROFILER_BUILD_TESTS ON)
+set(ROCPROFILER_BUILD_TESTS OFF)
 set(ROCPROFILER_BUILD_CI ON)
 
 if(ROCPROFILER_BUILD_CI)
diff --git a/src/core/metrics.h b/src/core/metrics.h
index 26bdeef..35ff8e8 100644
--- a/src/core/metrics.h
+++ b/src/core/metrics.h
@@ -209,8 +209,9 @@ class MetricsDict {
       std::unordered_set<std::string> supported_agent_names = {
           "gfx906",  "gfx908",  "gfx90a",   // Vega
           "gfx940",  "gfx941",  "gfx942",   // Mi300
-          "gfx1030", "gfx1031", "gfx1032",  // Navi2x
-          "gfx1100", "gfx1101", "gfx1102"   // Navi3x
+          "gfx1010",
+          "gfx1030", "gfx1031", "gfx1032", "gfx1035", "gfx1036",  // Navi2x
+          "gfx1100", "gfx1101", "gfx1102", "gfx1103"   // Navi3x
       };
       if (supported_agent_names.find(agent_name_) != supported_agent_names.end()) {
         ImportMetrics(agent_info, agent_name_);
diff --git a/src/core/session/att/continuous.cpp b/src/core/session/att/continuous.cpp
index 1e44e3d..be78a49 100644
--- a/src/core/session/att/continuous.cpp
+++ b/src/core/session/att/continuous.cpp
@@ -194,7 +194,7 @@ void AttTracer::InsertPacketStop(
       queue.GetGPUAgent(),
       rsignal.session_id_snapshot,
       queue.GetQueueID(),
-      rsignal.writer_id,
+      (uint32_t)rsignal.writer_id,
       interrupt_signal
   });
 
diff --git a/src/util/hsa_rsrc_factory.cpp b/src/util/hsa_rsrc_factory.cpp
index a419f49..4a33093 100644
--- a/src/util/hsa_rsrc_factory.cpp
+++ b/src/util/hsa_rsrc_factory.cpp
@@ -46,6 +46,8 @@ POSSIBILITY OF SUCH DAMAGE.
 #include <string>
 #include <vector>
 
+#define ROCP_LD_AQLPROFILE 1
+
 namespace rocprofiler {
 namespace util {
 
diff --git a/tests-v2/unittests/profiler/CMakeLists.txt b/tests-v2/unittests/profiler/CMakeLists.txt
index e84d1a7..740a807 100644
--- a/tests-v2/unittests/profiler/CMakeLists.txt
+++ b/tests-v2/unittests/profiler/CMakeLists.txt
@@ -11,7 +11,7 @@
 # The above copyright notice and this permission notice shall be included in all
 # copies or substantial portions of the Software.
 #
-# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR                               ROCM_PATH
 # IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 # FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
 # AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
@@ -27,7 +27,7 @@ find_library(PCIACCESS_LIBRARIES pciaccess REQUIRED)
 enable_testing()
 find_package(GTest REQUIRED)
 
-find_library(GDB rocm-dbgapi PATHS ${ROCM_PATH} REQUIRED)
+find_library(GDB rocm-dbgapi PATHS ${ROCM_PATH}/lib64 REQUIRED)
 
 # Getting Source files for ROCProfiler, Hardware, HSA, Memory, Session, Counters, Utils
 set(CORE_MEMORY_DIR ${PROJECT_SOURCE_DIR}/src/core/memory)
@@ -158,4 +158,4 @@ endif()
 # for the *_FilePlugin tests
 if(NOT EXISTS "${PROJECT_BINARY_DIR}/test-output")
     file(MAKE_DIRECTORY "${PROJECT_BINARY_DIR}/test-output")
-endif()
\ No newline at end of file
+endif()
-- 
2.41.1

