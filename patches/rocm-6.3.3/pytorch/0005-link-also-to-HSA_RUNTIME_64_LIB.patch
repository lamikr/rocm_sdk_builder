From ba05e8b1486dd874fff30e358fffeecd391fe1e4 Mon Sep 17 00:00:00 2001
From: Mika Laitio <lamikr@gmail.com>
Date: Wed, 19 Mar 2025 20:58:00 -0700
Subject: [PATCH 5/6] link also to HSA_RUNTIME_64_LIB

- cmake library search works differently on ubuntu 24.04
  compared to other distros.and fails to
  build pytorch because it not finding the hsa-runtime64.
  It seems that cmake in ubuntu can not search recursively
  subdirectories, and to get get pytorch building on
  on ubuntu we need to introduce the
  HSA_RUNTIME_LIBS and add that explicitly to search path
- disable building of pytorch tests
  which will require special handling
  to link agains hsa-runtime64. On other distros
  these tests are be disabled by default...

Signed-off-by: Mika Laitio <lamikr@gmail.com>
---
 cmake/public/LoadHIP.cmake      | 2 ++
 torch/lib/libshm/CMakeLists.txt | 1 +
 2 files changed, 3 insertions(+)

diff --git a/cmake/public/LoadHIP.cmake b/cmake/public/LoadHIP.cmake
index a91f0d0381f..7eff0e6b10f 100644
--- a/cmake/public/LoadHIP.cmake
+++ b/cmake/public/LoadHIP.cmake
@@ -171,6 +171,8 @@ if(HIP_FOUND)
 
     # roctx is part of roctracer
     find_library(ROCM_ROCTX_LIB roctx64 HINTS ${ROCM_PATH}/lib64 ${ROCM_PATH}/lib)
+    # linking does not work otherwise on ubuntu 24.04
+    find_library(HSA_RUNTIME64_LIB hsa-runtime64 HINTS ${ROCM_PATH}/lib64 ${ROCM_PATH}/lib)
 
     # check whether HIP declares new types
     set(PROJECT_RANDOM_BINARY_DIR "${PROJECT_BINARY_DIR}")
diff --git a/torch/lib/libshm/CMakeLists.txt b/torch/lib/libshm/CMakeLists.txt
index 8a7329ddab7..fba1921bbce 100644
--- a/torch/lib/libshm/CMakeLists.txt
+++ b/torch/lib/libshm/CMakeLists.txt
@@ -65,6 +65,7 @@ if(BUILD_LIBTORCHLESS)
 else()
   # we need to link directly to c10 here otherwise we miss symbols
   target_link_libraries(torch_shm_manager PRIVATE shm c10)
+  target_link_libraries(torch_shm_manager PRIVATE ${HSA_RUNTIME64_LIB})
 endif()
 set_target_properties(torch_shm_manager PROPERTIES
   INSTALL_RPATH "${_rpath_portable_origin}/../lib")
-- 
2.48.1

